<div class="modal fade" id="search_location_modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Search a location in OSM</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-sm-8">
                        <input type="text" name="location_osm" id="id_location_osm" class="form-control is-invalid" placeholder="Location search" required>
                    </div>
                    <div class="col-sm-4">
                        <button type="submit" class="btn btn-primary" onclick="nominatimSearch()">Search</button>
                    </div>
                </div>
                <section id="location_osm_search_results" class="mt-3"></section>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
async function nominatimSearch() {
    var modalElement = document.getElementById("search_location_modal");
    var searchInputElement = document.getElementById("id_location_osm");
    var searchResultsElement = document.getElementById("location_osm_search_results");

    if (searchInputElement.value.length) {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${searchInputElement.value}&format=json&limit=5`);
        const locations = await response.json();
        if (locations.length) {
            var ul = document.createElement("ul");
            for (var i = 0; i < locations.length; ++i) {
                var locationText = locations[i].display_name;
                var locationOSMID = locations[i].osm_id;
                var li = document.createElement("li");
                li.style.cursor = "pointer";
                li.innerHTML = `ðŸ“ ${locationText}`;
                li.addEventListener("click", function (event) {
                    // update input
                    document.getElementById("id_location_name").value = locationText;
                    document.getElementById("id_location_osm_id").value = locationOSMID;
                    // close modal
                    var modal = bootstrap.Modal.getInstance(modalElement);
                    modal.hide();
                });
                ul.appendChild(li);
            }
            searchResultsElement.appendChild(ul);
        } else {
            var p = document.createElement("p");
            p.innerHTML = "no results found";
            searchResultsElement.append(p);
        }
    }
}

document.addEventListener("DOMContentLoaded", function() {
    var modalElement = document.getElementById("search_location_modal");
    var searchInputElement = document.getElementById("id_location_osm");

    // focus input
    modalElement.addEventListener("shown.bs.modal", function (event) {
        searchInputElement.focus();
    });
});
</script>
